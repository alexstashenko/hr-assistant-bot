#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
HR Assistant Telegram Bot
–ö–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º –Ω–∞ –±–∞–∑–µ Claude AI
"""

import os
import logging
import re
import json
from typing import Dict, List
from datetime import datetime
from pathlib import Path

import anthropic
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)
from dotenv import load_dotenv
from http.server import HTTPServer, BaseHTTPRequestHandler
import threading
import io

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env —Ñ–∞–π–ª–∞
load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –§–∞–π–ª—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
USER_DATA_FILE = "user_data.json"
CONVERSATIONS_DIR = "conversations"

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Claude
SYSTEM_PROMPT = """# **–†–û–õ–¨: –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º**

–í—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ª—é–¥—å–º–∏, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ —Å–≤–æ–∏–º–∏ –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã–º–∏, –∞ —Ç–∞–∫–∂–µ –ø–æ–º–æ–≥–∞–µ—Ç –ø–æ–¥—á–∏–Ω–µ–Ω–Ω—ã–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Ä–∞–±–æ—Ç–∞—å —Å–æ —Å–≤–æ–∏–º–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è–º–∏ –∏ –∫–æ–ª–ª–µ–≥–∞–º–∏. –í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ, –ø—Ä–∏–º–µ–Ω–∏–º—ã–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.

---

## **–û–ë–õ–ê–°–¢–ò –≠–ö–°–ü–ï–†–¢–ò–ó–´:**

- –ú–æ—Ç–∏–≤–∞—Ü–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–¥–∞—á –∏ —Ü–µ–ª–µ–π
- –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–π
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å (–ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–∞—è)
- –†–∞–∑–≤–∏—Ç–∏–µ –∏ —Ä–æ—Å—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤
- –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- –ê–¥–∞–ø—Ç–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (onboarding)
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ–º –∏ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–æ–π
- –°–ª–æ–∂–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã (—É–≤–æ–ª—å–Ω–µ–Ω–∏—è, –ø–æ–Ω–∏–∂–µ–Ω–∏—è, –æ—Ç–∫–∞–∑—ã)
- –£–¥–µ—Ä–∂–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤

---

## **–ë–ê–ó–û–í–´–ï –ú–û–î–ï–õ–ò –ò –§–†–ï–ô–ú–í–û–†–ö–ò:**

### **–ú–æ–¥–µ–ª—å PAEI –ê–¥–∏–∑–µ—Å–∞**
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∏–ø–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –ø–æ–¥–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥–∞:
- **P (Producer)** ‚Äî –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å: –¥–µ–ª–∞–µ—Ç, –¥–æ—Å—Ç–∏–≥–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, —Ñ–æ–∫—É—Å –Ω–∞ "—á—Ç–æ"
- **A (Administrator)** ‚Äî –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä: —Å–∏—Å—Ç–µ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç, –æ—Ä–≥–∞–Ω–∏–∑—É–µ—Ç, —Ñ–æ–∫—É—Å –Ω–∞ "–∫–∞–∫"
- **E (Entrepreneur)** ‚Äî –ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–¥–µ–∏, –º–µ–Ω—è–µ—Ç, —Ñ–æ–∫—É—Å –Ω–∞ "–∑–∞—á–µ–º/—á—Ç–æ –µ—Å–ª–∏"
- **I (Integrator)** ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ç–æ—Ä: –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É, —Å–æ–∑–¥–∞–µ—Ç –∞—Ç–º–æ—Å—Ñ–µ—Ä—É, —Ñ–æ–∫—É—Å –Ω–∞ "–∫—Ç–æ"

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∏–π —Å—Ç–∏–ª—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–æ—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å, –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞—Ç—å –∏ –¥–∞–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.

### **–°–∏—Ç—É–∞—Ü–∏–æ–Ω–Ω–æ–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –•–µ—Ä—Å–∏-–ë–ª–∞–Ω—à–∞—Ä–∞**
–í—ã–±–∏—Ä–∞–π—Ç–µ —Å—Ç–∏–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É—Ä–æ–≤–Ω—è –∑—Ä–µ–ª–æ—Å—Ç–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:

**–£—Ä–æ–≤–µ–Ω—å –∑—Ä–µ–ª–æ—Å—Ç–∏ = –ö–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å √ó –ú–æ—Ç–∏–≤–∞—Ü–∏—è**

- **S1 ‚Äî –î–∏—Ä–µ–∫—Ç–∏–≤–Ω—ã–π** (–ù–∏–∑–∫–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –ù–∏–∑–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è): –ß–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∫–æ–Ω—Ç—Ä–æ–ª—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- **S2 ‚Äî –ù–∞—Å—Ç–∞–≤–Ω–∏—á–µ—Å–∫–∏–π** (–ù–∏–∑–∫–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –í—ã—Å–æ–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è): –û–±—ä—è—Å–Ω–µ–Ω–∏—è, –æ–±—É—á–µ–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- **S3 ‚Äî –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π** (–í—ã—Å–æ–∫–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –ù–∏–∑–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è): –í–æ–≤–ª–µ—á–µ–Ω–∏–µ, –æ–±—Å—É–∂–¥–µ–Ω–∏–µ, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ
- **S4 ‚Äî –î–µ–ª–µ–≥–∏—Ä—É—é—â–∏–π** (–í—ã—Å–æ–∫–∞—è –∫–æ–º–ø–µ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å + –í—ã—Å–æ–∫–∞—è –º–æ—Ç–∏–≤–∞—Ü–∏—è): –ê–≤—Ç–æ–Ω–æ–º–∏—è, –¥–æ–≤–µ—Ä–∏–µ, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –ü–µ—Ä–µ–¥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –æ—Ü–µ–Ω–∏—Ç–µ, –Ω–∞ –∫–∞–∫–æ–º —É—Ä–æ–≤–Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—Ç–∏–ª—å.

---

## **–ê–õ–ì–û–†–ò–¢–ú –†–ê–ë–û–¢–´:**

### **–®–∞–≥ 0: –ë—ã—Å—Ç—Ä–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**
–ü–µ—Ä–µ–¥ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –º—ã—Å–ª–µ–Ω–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Ç–∏–ø —Å–∏—Ç—É–∞—Ü–∏–∏:
- –ü—Ä–æ–±–ª–µ–º–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ vs. –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞
- –ù–æ–≤—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ vs. –æ–ø—ã—Ç–Ω—ã–π
- –û—Å—Ç—Ä–∞—è —Å–∏—Ç—É–∞—Ü–∏—è vs. —Ö—Ä–æ–Ω–∏—á–µ—Å–∫–∞—è
- –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è vs. –∫–æ–º–∞–Ω–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### **–®–∞–≥ 1: –£—Ç–æ—á–Ω–µ–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏**
–ö–æ–≥–¥–∞ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å –∏–ª–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è —Å –ø—Ä–æ–±–ª–µ–º–æ–π, –∑–∞–¥–∞–π—Ç–µ 3-4 –≤–æ–ø—Ä–æ—Å–∞, –ø–æ –æ–¥–Ω–æ–º—É –≤–æ–ø—Ä–æ—Å—É –∑–∞ —Ä–∞–∑, –¥–æ–∂–∏–¥–∞–π—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞:

**–ë–∞–∑–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**
1. –ß—Ç–æ —É–∂–µ –±—ã–ª–æ –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç–æ?
2. –ö–∞–∫ –¥–æ–ª–≥–æ –¥–ª–∏—Ç—Å—è —Å–∏—Ç—É–∞—Ü–∏—è?
3. –ö–∞–∫–æ–≤–∞ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ / —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è (–æ–ø—ã—Ç, —Ä–æ–ª—å, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏)?
4. –ö–∞–∫–æ–≤ –∂–µ–ª–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç?

**–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏):**
- –†–∞–∑–º–µ—Ä –≤–∞—à–µ–π –∫–æ–º–∞–Ω–¥—ã?
- –í–∞—à –æ–ø—ã—Ç –≤ —Ä–æ–ª–∏ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è (–Ω–æ–≤—ã–π/–æ–ø—ã—Ç–Ω—ã–π)?
- –ï—Å—Ç—å –ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏, —Å—Ä–æ–∫–∏, –±—é–¥–∂–µ—Ç)?
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –∫—É–ª—å—Ç—É—Ä–∞ (—Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è/—Å–≤–æ–±–æ–¥–Ω–∞—è, –∏–µ—Ä–∞—Ä—Ö–∏—á–Ω–∞—è/–ø–ª–æ—Å–∫–∞—è)?

### **–®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç:

**1. –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)**
- –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã
- –¢–∏–ø —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ PAEI (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
- –£—Ä–æ–≤–µ–Ω—å –∑—Ä–µ–ª–æ—Å—Ç–∏ –ø–æ –•–µ—Ä—Å–∏-–ë–ª–∞–Ω—à–∞—Ä—É (S1/S2/S3/S4)

**2. –ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô**
- –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–¥–µ–ª–∞—Ç—å

**3. –ß–¢–û –°–ö–ê–ó–ê–¢–¨**
–ì–æ—Ç–æ–≤—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

**4. –ß–ï–ì–û –ò–ó–ë–ï–ì–ê–¢–¨**
–¢–æ–ø-3 —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏

**5. –ö–†–ê–°–ù–´–ï –§–õ–ê–ì–ò** (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)
–ü—Ä–∏–∑–Ω–∞–∫–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è HR/—é—Ä–∏—Å—Ç–∞:
- –£–≥—Ä–æ–∑—ã, –∞–≥—Ä–µ—Å—Å–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤
- –î–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ü–∏—è, —Ö–∞—Ä–∞—Å—Å–º–µ–Ω—Ç
- –ü—Ä–∏–∑–Ω–∞–∫–∏ –≤—ã–≥–æ—Ä–∞–Ω–∏—è –∏–ª–∏ –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –∫—Ä–∏–∑–∏—Å–∞
- –ù–∞—Ä—É—à–µ–Ω–∏—è —ç—Ç–∏–∫–∏/–∫–æ–º–ø–ª–∞–µ–Ω—Å–∞

---

## **–ë–´–°–¢–†–´–ï –®–ê–ë–õ–û–ù–´**

–î–ª—è —Ç–∏–ø–æ–≤—ã—Ö —Å–∏—Ç—É–∞—Ü–∏–π –¥–∞–≤–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –º–∏–Ω–∏-—Å–∫—Ä–∏–ø—Ç—ã:

**–°–ª–æ–∂–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:**
"[–ò–º—è], —è —Ö–æ—á—É –æ–±—Å—É–¥–∏—Ç—å [–∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è]. –Ø –∑–∞–º–µ—Ç–∏–ª [—Ñ–∞–∫—Ç –±–µ–∑ –æ—Ü–µ–Ω–∫–∏]. –≠—Ç–æ –≤–ª–∏—è–µ—Ç –Ω–∞ [–ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è]. –î–∞–≤–∞–π –≤–º–µ—Å—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?"

**–û—Ç–∫–∞–∑ –≤ –ø–æ–≤—ã—à–µ–Ω–∏–∏/–ø—Ä–µ–º–∏–∏:**
"–¶–µ–Ω—é —Ç–≤–æ–π –≤–∫–ª–∞–¥ –≤ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è]. –°–µ–π—á–∞—Å —Ä–µ—à–µ–Ω–∏–µ –ø–æ –ø–æ–≤—ã—à–µ–Ω–∏—é ‚Äî [–ø—Ä–∏—á–∏–Ω–∞]. –ß—Ç–æ–±—ã –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ —ç—Ç–æ–π —Ü–µ–ª–∏, –Ω—É–∂–Ω–æ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —à–∞–≥–∏]. –ì–æ—Ç–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ç–µ–±—è –≤ —ç—Ç–æ–º."

**–î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏:**
"–£ –º–µ–Ω—è –µ—Å—Ç—å –∑–∞–¥–∞—á–∞ [–Ω–∞–∑–≤–∞–Ω–∏–µ]. –†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å [–æ–ø–∏—Å–∞–Ω–∏–µ]. –†–µ—Å—É—Ä—Å—ã: [—á—Ç–æ –¥–æ—Å—Ç—É–ø–Ω–æ]. –°—Ä–æ–∫: [–∫–æ–≥–¥–∞]. –ß—Ç–æ —Ç–µ–±–µ –Ω—É–∂–Ω–æ –æ—Ç –º–µ–Ω—è –¥–ª—è —É—Å–ø–µ—Ö–∞?"

**1-on-1 –≤—Å—Ç—Ä–µ—á–∞:**
"–¢—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞: –ö–∞–∫ —É —Ç–µ–±—è –¥–µ–ª–∞? –ß—Ç–æ —Ç–µ–±–µ —Å–µ–π—á–∞—Å –Ω—É–∂–Ω–æ –æ—Ç –º–µ–Ω—è? –ß—Ç–æ —è –º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å –ª—É—á—à–µ –∫–∞–∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å?"

---

## **–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:**

- –û–±—â–∞–π—Ç–µ—Å—å –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ "–≤—ã"
- –ü–∏—à–∏—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É ‚Äî –Ω–∏–∫–∞–∫–æ–π –≤–æ–¥—ã
- –î–∞–≤–∞–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ –∏ –¥–µ–π—Å—Ç–≤–∏–π, –∞ –Ω–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã
- –ë—É–¥—å—Ç–µ —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –∫ –æ–±–µ–∏–º —Å—Ç–æ—Ä–æ–Ω–∞–º (—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫—É)
- –£—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –±–∏–∑–Ω–µ—Å–∞ (—Å—Ä–æ–∫–∏, —Ä–µ—Å—É—Ä—Å—ã, –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–º–ø–∞–Ω–∏–∏)
- –ï—Å–ª–∏ —Å–∏—Ç—É–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞ HR –∏–ª–∏ —é—Ä–∏—Å—Ç–∞ ‚Äî —Å–∫–∞–∂–∏—Ç–µ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ
- –§–æ–∫—É—Å –Ω–∞ –±—ã—Å—Ç—Ä—ã—Ö —Ç–æ—á–µ—á–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö
- **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ** –¥–ª—è –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, * –¥–ª—è –∫—É—Ä—Å–∏–≤–∞, # –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, ``` –¥–ª—è –∫–æ–¥–∞. –ü–∏—à–∏—Ç–µ –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.
- –î–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ó–ê–ì–õ–ê–í–ù–´–ï –ë–£–ö–í–´ –∏–ª–∏ "–∫–∞–≤—ã—á–∫–∏"
- –î–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Å—Ç—ã–µ –º–∞—Ä–∫–µ—Ä—ã: ‚Ä¢, -, —Ü–∏—Ñ—Ä—ã

---

## **–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:**

1. **–ö–∞–∂–¥—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ —É–Ω–∏–∫–∞–ª–µ–Ω** ‚Äî –Ω–µ—Ç —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π
2. **–°–Ω–∞—á–∞–ª–∞ –ø–æ–Ω—è—Ç—å, –ø–æ—Ç–æ–º –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å** ‚Äî –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∞–∂–Ω–µ–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
3. **–§–æ–∫—É—Å –Ω–∞ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö**, –∞ –Ω–µ –Ω–∞ –ª–∏—á–Ω–æ—Å—Ç–∏
4. **–†–∞–∑–≤–∏—Ç–∏–µ –≤–∞–∂–Ω–µ–µ –Ω–∞–∫–∞–∑–∞–Ω–∏—è** ‚Äî –Ω–æ –µ—Å—Ç—å —Å–∏—Ç—É–∞—Ü–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ –∂–µ—Å—Ç–∫–∏—Ö –º–µ—Ä
5. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤** ‚Äî —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö)
6. **–ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å—Ä–æ—á–Ω–æ—Å—Ç—å—é –±–∏–∑–Ω–µ—Å–∞ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ–º –ª—é–¥–µ–π** ‚Äî –ø–æ–º–æ–≥–∞–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é –Ω–∞–π—Ç–∏ —ç—Ç—É –≥—Ä–∞–Ω—å
7. **–ê–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ —Å—Ç–∏–ª—å –ø–æ–¥ —Å–∏—Ç—É–∞—Ü–∏—é** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –º–æ–¥–µ–ª–∏ PAEI –∏ –•–µ—Ä—Å–∏-–ë–ª–∞–Ω—à–∞—Ä–∞

---

## **–ù–ê–ß–ê–õ–û –†–ê–ë–û–¢–´:**

–ù–∞—á–∏–Ω–∞–π—Ç–µ —Ä–∞–±–æ—Ç—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–∏—à–µ—Ç —Å–≤–æ—é —Å–∏—Ç—É–∞—Ü–∏—é. 

**–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –æ–¥–Ω–æ–º—É –∑–∞ —Ä–∞–∑, –¥–æ–∂–∏–¥–∞–π—Ç–µ—Å—å –æ—Ç–≤–µ—Ç–∞, –∑–∞—Ç–µ–º —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.**"""


class HealthCheckHandler(BaseHTTPRequestHandler):
    """HTTP handler –¥–ª—è health checks –æ–±–ª–∞—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º"""
    
    def do_GET(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ GET –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è"""
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b'HR Assistant Bot is running')
    
    def log_message(self, format, *args):
        """–û—Ç–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ health check –∑–∞–ø—Ä–æ—Å–æ–≤"""
        pass


def start_health_server():
    """–ó–∞–ø—É—Å–∫ HTTP —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è health checks"""
    port = int(os.getenv('PORT', 8080))
    try:
        server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
        thread = threading.Thread(target=server.serve_forever, daemon=True)
        thread.start()
        logger.info(f"Health check server started on port {port}")
    except Exception as e:
        logger.warning(f"Could not start health check server: {e}")


def clean_markdown(text: str) -> str:
    """–£–¥–∞–ª—è–µ—Ç markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ Telegram"""
    try:
        # –£–¥–∞–ª—è–µ–º –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (**text** –∏–ª–∏ __text__)
        text = re.sub(r'\*\*(.+?)\*\*', r'\1', text)
        text = re.sub(r'__(.+?)__', r'\1', text)
        
        # –£–¥–∞–ª—è–µ–º –∫—É—Ä—Å–∏–≤ –ø—Ä–æ—Å—Ç—ã–º —Å–ø–æ—Å–æ–±–æ–º
        text = text.replace('*', '')
        text = text.replace('_', '')
        
        # –£–¥–∞–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (# ## ### –∏ —Ç.–¥.)
        text = re.sub(r'^#{1,6}\s+', '', text, flags=re.MULTILINE)
        
        # –£–¥–∞–ª—è–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
        text = re.sub(r'```.*?```', '', text, flags=re.DOTALL)
        
        # –£–¥–∞–ª—è–µ–º –∏–Ω–ª–∞–π–Ω –∫–æ–¥
        text = re.sub(r'`([^`]+)`', r'\1', text)
        
        # –£–¥–∞–ª—è–µ–º —Ç–∏–ª—å–¥—ã
        text = text.replace('~~', '')
        
        return text.strip()
    except Exception as e:
        # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤–µ—Ä–Ω–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
        logger.warning(f"Error in clean_markdown: {e}")
        return text


class HRAssistantBot:
    """–ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è HR-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º –±–æ—Ç–æ–º"""
    
    def __init__(self, telegram_token: str, anthropic_api_key: str, admin_telegram_id: int):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
        
        Args:
            telegram_token: –¢–æ–∫–µ–Ω Telegram –±–æ—Ç–∞
            anthropic_api_key: API –∫–ª—é—á Anthropic
            admin_telegram_id: Telegram ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        """
        self.telegram_token = telegram_token
        self.anthropic_client = anthropic.Anthropic(api_key=anthropic_api_key)
        self.admin_telegram_id = admin_telegram_id
        
        # –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (—Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
        self.conversations: Dict[int, List[Dict]] = {}
        
        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–æ–∫
        Path(CONVERSATIONS_DIR).mkdir(exist_ok=True)
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏–∑ —Ñ–∞–π–ª–∞
        self.user_data = self.load_user_data()
        
        # Telegram Application (–±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ run())
        self.application = None
        
    def load_user_data(self) -> Dict:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –∏–∑ —Ñ–∞–π–ª–∞"""
        if Path(USER_DATA_FILE).exists():
            try:
                with open(USER_DATA_FILE, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                    logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ {len(data)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö")
                    return data
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
                return {}
        return {}
    
    def save_user_data(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö –≤ —Ñ–∞–π–ª"""
        try:
            with open(USER_DATA_FILE, 'w', encoding='utf-8') as f:
                json.dump(self.user_data, f, ensure_ascii=False, indent=2)
            logger.info("–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {e}")
    
    def save_conversation_to_file(self, user_id: int):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–∞–π–ª"""
        try:
            conversation_file = Path(CONVERSATIONS_DIR) / f"user_{user_id}.json"
            with open(conversation_file, 'w', encoding='utf-8') as f:
                json.dump(self.conversations.get(user_id, []), f, ensure_ascii=False, indent=2)
            logger.info(f"–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏: {e}")
    
    def load_conversation_from_file(self, user_id: int) -> List[Dict]:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–∞–π–ª–∞"""
        conversation_file = Path(CONVERSATIONS_DIR) / f"user_{user_id}.json"
        if conversation_file.exists():
            try:
                with open(conversation_file, 'r', encoding='utf-8') as f:
                    return json.load(f)
            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏: {e}")
                return []
        return []
    
    def get_user_info(self, user_id: int) -> Dict:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        user_id_str = str(user_id)
        if user_id_str not in self.user_data:
            self.user_data[user_id_str] = {
                "message_count": 0,
                "demo_completed_notified": False,
                "first_seen": datetime.now().isoformat(),
                "username": None,
                "first_name": None
            }
            self.save_user_data()
        return self.user_data[user_id_str]
    
    def update_user_info(self, user_id: int, username: str = None, first_name: str = None):
        """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
        user_info = self.get_user_info(user_id)
        if username:
            user_info["username"] = username
        if first_name:
            user_info["first_name"] = first_name
        self.save_user_data()
    
    def get_message_limit(self, user_id: int) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id == self.admin_telegram_id:
            return 1000
        return 20
    
    def get_remaining_messages(self, user_id: int) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π"""
        limit = self.get_message_limit(user_id)
        user_info = self.get_user_info(user_id)
        used = user_info.get("message_count", 0)
        return max(0, limit - used)
    
    def increment_message_count(self, user_id: int):
        """–£–≤–µ–ª–∏—á–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        user_info = self.get_user_info(user_id)
        user_info["message_count"] = user_info.get("message_count", 0) + 1
        self.save_user_data()
        
        logger.info(
            f"User {user_id}: —Å–æ–æ–±—â–µ–Ω–∏–µ {user_info['message_count']}/{self.get_message_limit(user_id)}"
        )
    
    def has_messages_left(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è"""
        return self.get_remaining_messages(user_id) > 0
    
    def reset_user_limit(self, user_id: int):
        """–°–±—Ä–æ—Å–∏—Ç—å –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
        user_info = self.get_user_info(user_id)
        user_info["message_count"] = 0
        user_info["demo_completed_notified"] = False
        self.save_user_data()
        logger.info(f"–ê–¥–º–∏–Ω —Å–±—Ä–æ—Å–∏–ª –ª–∏–º–∏—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    
    def format_conversation_as_text(self, user_id: int) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç"""
        conversation = self.conversations.get(user_id, [])
        user_info = self.get_user_info(user_id)

        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é text
        text = ""
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        text += f"–ò–°–¢–û–†–ò–Ø –ü–ï–†–ï–ü–ò–°–ö–ò\n"
        text += f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_info.get('first_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
        text += f"Username: @{user_info.get('username', '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n"
        text += f"Telegram ID: {user_id}\n"
        text += f"–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {user_info.get('first_seen', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}\n"
        text += f"–í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(conversation)}\n"
        text += f"–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–º–æ: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n"
        text += f"\n" + "=" * 80 + "\n\n"
        
        # –ü–µ—Ä–µ–ø–∏—Å–∫–∞
        for i, msg in enumerate(conversation, 1):
            role = "–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨" if msg["role"] == "user" else "–ê–°–°–ò–°–¢–ï–ù–¢"
            text += f"[{i}] {role}:\n"
            text += f"{msg['content']}\n\n"
        
        text += "–ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò –ü–ï–†–ï–ü–ò–°–ö–ò\n"
        
        return text
    
    async def send_conversation_history(self, user_id: int):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"""
        try:
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ —Ç–µ–∫—Å—Ç
            conversation_text = self.format_conversation_as_text(user_id)
            
            # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏
            text_file = io.BytesIO(conversation_text.encode('utf-8'))
            text_file.name = f"conversation_user_{user_id}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.txt"
            
            user_info = self.get_user_info(user_id)
            caption = (
                f"–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:\n\n"
                f"üë§ {user_info.get('first_name', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
                f"üì± @{user_info.get('username', '–Ω–µ —É–∫–∞–∑–∞–Ω')}\n"
                f"üÜî {user_id}\n"
                f"üìä –°–æ–æ–±—â–µ–Ω–∏–π: {len(self.conversations.get(user_id, []))}"
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –∞–¥–º–∏–Ω—É
            await self.application.bot.send_document(
                chat_id=self.admin_telegram_id,
                document=text_file,
                caption=caption,
                filename=text_file.name
            )
            
            logger.info(f"–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—É")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –∞–¥–º–∏–Ω—É: {e}")
    
    async def notify_admin_demo_complete(self, user_id: int, username: str, first_name: str):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–µ–º–æ —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏"""
        try:
            # –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            message = (
                f"üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–ï: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≤–µ—Ä—à–∏–ª –î–ï–ú–û\n\n"
                f"–ò–º—è: {first_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}\n"
                f"Username: @{username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n"
                f"Telegram ID: {user_id}\n"
                f"–í—Ä–µ–º—è: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å—á–µ—Ä–ø–∞–ª 20 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n"
                f"üìé –ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∞ –Ω–∏–∂–µ."
            )
            
            await self.application.bot.send_message(
                chat_id=self.admin_telegram_id,
                text=message
            )
            
            # –ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª —Å –∏—Å—Ç–æ—Ä–∏–µ–π –ø–µ—Ä–µ–ø–∏—Å–∫–∏
            await self.send_conversation_history(user_id)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –≤ —Ñ–∞–π–ª –¥–ª—è –∞—Ä—Ö–∏–≤–∞
            self.save_conversation_to_file(user_id)
            
            # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ
            user_info = self.get_user_info(user_id)
            user_info["demo_completed_notified"] = True
            self.save_user_data()
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –¥–µ–º–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user_id}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω—É: {e}")
    
    def get_conversation_history(self, user_id: int) -> List[Dict]:
        """–ü–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id not in self.conversations:
            # –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞
            self.conversations[user_id] = self.load_conversation_from_file(user_id)
        return self.conversations[user_id]
    
    def add_message_to_history(self, user_id: int, role: str, content: str):
        """–î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        if user_id not in self.conversations:
            self.conversations[user_id] = self.load_conversation_from_file(user_id)
        
        self.conversations[user_id].append({
            "role": role,
            "content": content
        })
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        self.save_conversation_to_file(user_id)
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 40 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (20 –ø–∞—Ä) –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ Claude
        # –ù–æ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ —Ñ–∞–π–ª
        if len(self.conversations[user_id]) > 40:
            # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            context_history = self.conversations[user_id][-40:]
            self.conversations[user_id] = context_history
    
    async def get_claude_response(self, user_id: int, user_message: str) -> str:
        """
        –ü–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç Claude
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            user_message: –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
        Returns:
            –û—Ç–≤–µ—Ç Claude
        """
        try:
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_message_to_history(user_id, "user", user_message)
            
            # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 40 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
            conversation_history = self.get_conversation_history(user_id)
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            logger.info(f"User {user_id}: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º {len(conversation_history)} —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—é")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ Claude
            response = self.anthropic_client.messages.create(
                model="claude-haiku-4-5-20251001",
                max_tokens=4096,
                system=SYSTEM_PROMPT,
                messages=conversation_history
            )
            
            # –õ–æ–≥–∏—Ä—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤
            logger.info(
                f"User {user_id}: input_tokens={response.usage.input_tokens}, "
                f"output_tokens={response.usage.output_tokens}"
            )
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Ç–≤–µ—Ç
            assistant_message = response.content[0].text
            
            # –û—á–∏—â–∞–µ–º –æ—Ç markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤ Telegram
            assistant_message = clean_markdown(assistant_message)
            
            # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_message_to_history(user_id, "assistant", assistant_message)
            
            return assistant_message
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç Claude: {e}")
            logger.error(f"–¢–∏–ø –æ—à–∏–±–∫–∏: {type(e).__name__}")
            logger.error(f"–î–µ—Ç–∞–ª–∏: {str(e)}")
            return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
        user = update.effective_user
        user_id = user.id
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        self.update_user_info(user_id, user.username, user.first_name)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø
        if not self.has_messages_left(user_id):
            await update.message.reply_text(
                "–î–ï–ú–û-–†–ï–ñ–ò–ú –ó–ê–í–ï–†–®–ï–ù\n\n"
                "–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ 20 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n"
                "–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É, "
                "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @alexander_stashenko\n\n"
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞! üôè"
            )
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π
        remaining = self.get_remaining_messages(user_id)
        limit = self.get_message_limit(user_id)
        
        demo_info = ""
        if limit == 20:
            demo_info = f"\n\n–î–ï–ú–û-–†–ï–ñ–ò–ú: –£ –≤–∞—Å {remaining} —Å–æ–æ–±—â–µ–Ω–∏–π"
        
        welcome_message = (
            f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!\n\n"
            "–Ø ‚Äî –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º –Ω–∞ –±–∞–∑–µ Claude AI."
            f"{demo_info}\n\n"
            "üéØ –Ø –ø–æ–º–æ–≥—É –≤–∞–º:\n"
            "‚Ä¢ –†–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å –º–æ—Ç–∏–≤–∞—Ü–∏–µ–π\n"
            "‚Ä¢ –î–∞–≤–∞—Ç—å —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å\n"
            "‚Ä¢ –†–µ—à–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –≤ –∫–æ–º–∞–Ω–¥–µ\n"
            "‚Ä¢ –£–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é\n"
            "‚Ä¢ –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Ä–∞–∑–≥–æ–≤–æ—Ä—ã\n"
            "‚Ä¢ –ò –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ!\n\n"
            "–ü—Ä–æ—Å—Ç–æ –æ–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é, –∏ —è –∑–∞–¥–∞–º —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã, "
            "—á—Ç–æ–±—ã –¥–∞—Ç—å –≤–∞–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.\n\n"
            "üí° –ö–æ–º–∞–Ω–¥–∞:\n"
            "/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é\n\n"
            "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º! –ö–∞–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –≤–∞—Å –±–µ—Å–ø–æ–∫–æ–∏—Ç?"
        )
        
        await update.message.reply_text(welcome_message)
        logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} ({user.username}) –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º")
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help"""
        user_id = update.effective_user.id
        remaining = self.get_remaining_messages(user_id)
        limit = self.get_message_limit(user_id)
        
        demo_info = ""
        if limit == 20:
            demo_info = f"\n\n–î–ï–ú–û-–†–ï–ñ–ò–ú: –û—Å—Ç–∞–ª–æ—Å—å {remaining} –∏–∑ {limit} —Å–æ–æ–±—â–µ–Ω–∏–π"
        
        help_message = (
            "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –±–æ—Ç–æ–º:\n\n"
            "1Ô∏è‚É£ –û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—É —Å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–º/–∫–æ–º–∞–Ω–¥–æ–π\n"
            "2Ô∏è‚É£ –Ø –∑–∞–¥–∞–º —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–ø–æ –æ–¥–Ω–æ–º—É)\n"
            "3Ô∏è‚É£ –ü–æ—Å–ª–µ —É—Ç–æ—á–Ω–µ–Ω–∏–π –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:\n"
            "   ‚Ä¢ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É —Å–∏—Ç—É–∞—Ü–∏–∏\n"
            "   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π\n"
            "   ‚Ä¢ –ì–æ—Ç–æ–≤—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤\n"
            "   ‚Ä¢ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö\n\n"
            "üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/start ‚Äî –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º\n"
            "/help ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:\n"
            "‚Ä¢ \"–ú–æ–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –ø–µ—Ä–µ—Å—Ç–∞–ª –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞—á–∏ –≤ —Å—Ä–æ–∫\"\n"
            "‚Ä¢ \"–ö–∞–∫ –¥–∞—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å –æ –ø–ª–æ—Ö–æ–π —Ä–∞–±–æ—Ç–µ?\"\n"
            "‚Ä¢ \"–î–≤–∞ —á–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –º–µ–∂–¥—É —Å–æ–±–æ–π\"\n"
            "‚Ä¢ \"–ù—É–∂–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –ø–æ–≤—ã—à–µ–Ω–∏–∏\"\n\n"
            "–Ø –∏—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (PAEI –ê–¥–∏–∑–µ—Å–∞, "
            "–°–∏—Ç—É–∞—Ü–∏–æ–Ω–Ω–æ–µ –ª–∏–¥–µ—Ä—Å—Ç–≤–æ –•–µ—Ä—Å–∏-–ë–ª–∞–Ω—à–∞—Ä–∞) –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π."
            f"{demo_info}"
        )
        
        await update.message.reply_text(help_message)
    
    async def grant_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /grant –¥–ª—è —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
        user_id = update.effective_user.id
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É –≤—ã–∑–≤–∞–ª –∞–¥–º–∏–Ω
        if user_id != self.admin_telegram_id:
            await update.message.reply_text("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥—ã
        if not context.args or len(context.args) != 1:
            await update.message.reply_text(
                "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /grant <user_id>\n\n"
                "–ü—Ä–∏–º–µ—Ä: /grant 123456789\n\n"
                "–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ 20."
            )
            return
        
        try:
            target_user_id = int(context.args[0])
            
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            self.reset_user_limit(target_user_id)
            
            user_info = self.get_user_info(target_user_id)
            username = user_info.get("username", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω")
            first_name = user_info.get("first_name", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
            
            await update.message.reply_text(
                f"‚úÖ –õ–∏–º–∏—Ç —Å–±—Ä–æ—à–µ–Ω!\n\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {first_name}\n"
                f"Username: @{username}\n"
                f"ID: {target_user_id}\n\n"
                f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏–ª –Ω–æ–≤—ã–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π."
            )
            
            logger.info(f"–ê–¥–º–∏–Ω {user_id} —Å–±—Ä–æ—Å–∏–ª –ª–∏–º–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {target_user_id}")
            
        except ValueError:
            await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
        except Exception as e:
            await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ª–∏–º–∏—Ç–∞: {e}")
    
    async def handle_message(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
        user = update.effective_user
        user_id = user.id
        user_message = update.message.text
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        self.update_user_info(user_id, user.username, user.first_name)
        
        logger.info(f"–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç {user_id} ({user.username}): {user_message[:50]}...")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è
        if not self.has_messages_left(user_id):
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏
            user_info = self.get_user_info(user_id)
            if not user_info.get("demo_completed_notified", False):
                await self.notify_admin_demo_complete(
                    user_id,
                    user.username or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                    user.first_name or "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
                )
            
            await update.message.reply_text(
                "–î–ï–ú–û-–†–ï–ñ–ò–ú –ó–ê–í–ï–†–®–ï–ù\n\n"
                "–í—ã –∏—Å—á–µ—Ä–ø–∞–ª–∏ 20 –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.\n\n"
                "–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–µ–Ω –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—É, "
                "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ @alexander_stashenko\n\n"
                "–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞! üôè"
            )
            return
        
        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        self.increment_message_count(user_id)
        
        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π
        remaining = self.get_remaining_messages(user_id)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        await update.message.chat.send_action("typing")
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç Claude
        response = await self.get_claude_response(user_id, user_message)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –¥–ª—è –¥–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        if self.get_message_limit(user_id) == 20:
            if remaining <= 5:  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ–º, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –º–∞–ª–æ
                response += f"\n\n‚ö†Ô∏è –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–π: {remaining}"
            elif remaining == 10:  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª–æ–≤–∏–Ω–µ
                response += f"\n\nüìä –û—Å—Ç–∞–ª–æ—Å—å —Å–æ–æ–±—â–µ–Ω–∏–π: {remaining}"
        
        # Telegram –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è (4096 —Å–∏–º–≤–æ–ª–æ–≤)
        # –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –¥–ª–∏–Ω–Ω–µ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
        if len(response) <= 4096:
            await update.message.reply_text(response)
        else:
            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –ø–æ 4000 —Å–∏–º–≤–æ–ª–æ–≤
            parts = [response[i:i+4000] for i in range(0, len(response), 4000)]
            for part in parts:
                await update.message.reply_text(part)
                await update.message.chat.send_action("typing")
        
        # –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        if remaining == 0:
            await self.notify_admin_demo_complete(
                user_id,
                user.username or "–Ω–µ —É–∫–∞–∑–∞–Ω",
                user.first_name or "–ù–µ —É–∫–∞–∑–∞–Ω–æ"
            )
    
    async def error_handler(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫"""
        logger.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {context.error}")
        
        if update and update.effective_message:
            await update.effective_message.reply_text(
                "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
            )
    
    def run(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"""
        # –ó–∞–ø—É—Å–∫–∞–µ–º health check —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–ª–∞—á–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º (Render, Railway, etc.)
        start_health_server()
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        self.application = Application.builder().token(self.telegram_token).build()
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
        self.application.add_handler(CommandHandler("start", self.start_command))
        self.application.add_handler(CommandHandler("help", self.help_command))
        self.application.add_handler(CommandHandler("grant", self.grant_command))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
        self.application.add_error_handler(self.error_handler)
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        logger.info("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        self.application.run_polling(allowed_updates=Update.ALL_TYPES)


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω—ã –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
    telegram_token = os.getenv("TELEGRAM_BOT_TOKEN")
    anthropic_api_key = os.getenv("ANTHROPIC_API_KEY")
    admin_telegram_id = os.getenv("ADMIN_TELEGRAM_ID")
    
    if not telegram_token:
        raise ValueError("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è TELEGRAM_BOT_TOKEN")
    
    if not anthropic_api_key:
        raise ValueError("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ANTHROPIC_API_KEY")
    
    if not admin_telegram_id:
        raise ValueError("–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è ADMIN_TELEGRAM_ID")
    
    try:
        admin_telegram_id = int(admin_telegram_id)
    except ValueError:
        raise ValueError("ADMIN_TELEGRAM_ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")
    
    # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    bot = HRAssistantBot(telegram_token, anthropic_api_key, admin_telegram_id)
    bot.run()


if __name__ == "__main__":
    main()
